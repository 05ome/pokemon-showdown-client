#!/usr/bin/env node
"use strict";

const fs = require("fs");
const path = require("path");
const child_process = require("child_process");

process.chdir(path.resolve(__dirname, "../play.pokemonshowdown.com"));

//
// ================================
// CONFIG — EDIT THESE TWO URLs
// ================================
//
// These must point to DIRECT RAW versions of your pre-built files.
// (I set them to your repo's raw paths; change if you want different sources.)
//
const REMOTE_MINI_URL =
  "https://raw.githubusercontent.com/05ome/pokemon-showdown/master/data/pokedex-mini.js";

const REMOTE_MINI_BW_URL =
  "https://raw.githubusercontent.com/05ome/pokemon-showdown/master/data/pokedex-mini-bw.js";

//
// Destination directory: /data/
//
const DEST_DIR = path.resolve("data");
const DEST_MINI = path.join(DEST_DIR, "pokedex-mini.js");
const DEST_MINI_BW = path.join(DEST_DIR, "pokedex-mini-bw.js");

if (!fs.existsSync(DEST_DIR)) fs.mkdirSync(DEST_DIR, { recursive: true });

//
// Simple download helper using curl or PowerShell (keeps original approach)
//
function downloadTo(url, dest) {
  // try curl first
  try {
    child_process.execSync(`curl -fsSL "${url}" -o "${dest}"`, {
      stdio: "ignore",
    });
    return true;
  } catch (e) {
    // curl failed — try PowerShell on Windows
  }

  try {
    // Use -UseBasicParsing for older PowerShell compatibility
    child_process.execSync(
      `powershell -Command "Invoke-WebRequest -Uri '${url}' -OutFile '${dest}' -UseBasicParsing"`,
      { stdio: "ignore" }
    );
    return true;
  } catch (e) {
    return false;
  }
}

console.log("Fetching prebuilt pokedex-mini files...");

let okMini = false;
let okMiniBW = false;

// Attempt download for normal mini file
if (downloadTo(REMOTE_MINI_URL, DEST_MINI)) {
  console.log("✓ pokedex-mini.js downloaded");
  okMini = true;
} else if (fs.existsSync(DEST_MINI)) {
  console.log("✓ pokedex-mini.js not downloaded but existing local file found, using it");
  okMini = true;
} else {
  console.warn("✗ pokedex-mini.js not downloaded and no local file found");
}

// Attempt download for BW/gen5 mini file
if (downloadTo(REMOTE_MINI_BW_URL, DEST_MINI_BW)) {
  console.log("✓ pokedex-mini-bw.js downloaded");
  okMiniBW = true;
} else if (fs.existsSync(DEST_MINI_BW)) {
  console.log("✓ pokedex-mini-bw.js not downloaded but existing local file found, using it");
  okMiniBW = true;
} else {
  console.warn("✗ pokedex-mini-bw.js not downloaded and no local file found");
}

// Decide success: succeed if either one is present
if (okMini || okMiniBW) {
  console.log("DONE — available files:");
  if (okMini) console.log("  - pokedex-mini.js (normal ani) is present");
  if (okMiniBW) console.log("  - pokedex-mini-bw.js (gen5/bw ani) is present");
  process.exit(0);
} else {
  console.error("FAILED TO DOWNLOAD pokedex-mini files AND no local copies found.");
  console.error("Check your REMOTE_* URLs or network access.");
  process.exit(1);
}
